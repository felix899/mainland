{% extends 'main/base.html' %}

{% block title %}{{ package.name }} - æ½›æ°´å¥—ç¥¨ç®¡ç†ç³»çµ±{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .breadcrumb a {
        color: #fbb700;
        text-decoration: none;
        font-weight: bold;
    }
    
    .breadcrumb a:hover {
        text-decoration: underline;
    }
    
    .package-hero {
        margin-bottom: 30px;
    }
    
    .package-hero-image {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        border-radius: 0px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .package-header {
        margin: 25px 0 25px 230px;
    }
    
    .package-title {
        font-size: 2.5em;
        color: #f17431;
        margin-bottom: 10px;
        text-align: left;
    }
    
    .package-subtitle {
        font-size: 1.3em;
        color: #666;
        margin-bottom: 20px;
        text-align: left;
    }
    
    .badges {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: flex-start;
    }
    
    .badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.95em;
        font-weight: bold;
    }
    
    .badge-type {
        background: #fbb700;
        color: white;
    }
    
    .badge-city {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-country {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .badge-featured {
        background: #ffd700;
        color: #333;
    }
    
    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 25px;
        justify-content: flex-start;
    }
    
    .tag {
        padding: 6px 14px;
        border-radius: 15px;
        font-size: 0.9em;
        color: white;
        font-weight: 500;
    }
    
    .info-section {
        background: white;
        padding: 25px;
        border-radius: 10px;

    }
    
    .info-section h2 {
        color: #fbb700;
        font-size: 1.8em;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid #fbb700;
    }
    
    /* å½©è‰²æ¨™é¡Œæ¬„æ¨£å¼ */
    .colored-section {
        background: white;
        border-radius: 0px;
        margin-bottom: 25px;
        overflow: hidden;
    }
    
    .colored-section-header {
        padding: 15px 25px;
        color: white;
        font-size: 1.5em;
        font-weight: bold;
        margin: 0;
    }
    
    .colored-section-header.yellow {
        background: #FBB700;
    }
    
    .colored-section-header.orange {
        background: #F17431;
    }
    
    .colored-section-content {
        padding: 25px;
        line-height: 1.8;
        color: #333;
    }
    
    .colored-section-content ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .colored-section-content li {
        margin-bottom: 8px;
    }
    
    .info-content {
        line-height: 1.8;
        color: #333;
        white-space: normal;
    }
    
    /* èª¿æ•´å¯Œæ–‡æœ¬æ®µè½é–“è·ä¸¦ç§»é™¤ç©ºæ®µè½é€ æˆçš„éå¤§ç©ºç™½ */
    .info-content p {
        margin: 0 0 10px;
    }
    .info-content p:last-child {
        margin-bottom: 0;
    }
    .info-content p:empty {
        display: none;
    }
    .info-content p:has(> br:only-child) {
        display: none;
    }
    
    .info-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .info-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }
    
    .info-content table th,
    .info-content table td {
        padding: 12px;
        border: 1px solid #ffae00;
        text-align: left;
    }
    
    .info-content table th {
        background: #fbb700;
        color: white;
        font-weight: bold;
    }
    
    .info-content table tr:nth-child(even) {
        background: white;
    }
    
    .hotel-section {
        margin-top: 30px;
    }
    
    .hotel-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .hotel-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s;
    }
    
    .hotel-card:hover {
        border-color: #fbb700;
        box-shadow: 0 5px 15px rgba(251, 183, 0, 0.3);
    }
    
    .hotel-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background: linear-gradient(135deg, #fbb700 0%, #f89c00 100%);
    }
    
    .hotel-body {
        padding: 15px;
    }
    
    .hotel-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }
    
    .hotel-website {
        color: #fbb700;
        text-decoration: none;
        font-size: 0.9em;
    }
    
    .hotel-website:hover {
        text-decoration: underline;
    }
    
    .meta-info {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
    }
    
    .meta-info p {
        margin: 8px 0;
        color: #555;
    }
    
    .meta-info strong {
        color: #1976d2;
    }
    
    .action-buttons {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .json-data {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 20px;
        border-radius: 10px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.6;
        white-space: pre-wrap;
    }
    
    .no-content {
        color: #999;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }
    
    /* å·¦å´å°èˆªé¸å–® */
    .side-nav {
        position: sticky;
        top: 20px;
        float: left;
        width: 200px;
        margin-right: 30px;
        margin-bottom: 30px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 0px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* ä¸»å…§å®¹å€åŒ…è£ */
    .content-wrapper {
        overflow: hidden;
    }
    
    .main-content {
        margin-left: 230px;
    }
    
    .side-nav-item {
        display: block;
        padding: 15px 20px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #e0e0e0;
        transition: all 0.3s;
        font-size: 0.95em;
        background: white;
    }
    
    .side-nav-item:hover {
        background: #f8f9fa;
        color: #fbb700;
    }
    
    .side-nav-item.active {
        background: #fbb700;
        color: white;
        font-weight: bold;
    }
    
    .side-nav-register {
        background: #f17431;
        padding: 15px 20px;
        text-align: center;
    }
    
    .side-nav-register .btn {
        width: 100%;
        text-align: center;
        padding: 0;
        font-size: 0.95em;
        background: transparent;
        color: white;
        box-shadow: none;
    }
    
    .side-nav-register .btn:hover {
        background: rgba(255,255,255,0.1);
        transform: none;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1024px) {
        .side-nav {
            float: none;
            width: 100%;
            margin-right: 0;
            margin-bottom: 20px;
            position: relative;
            top: 0;
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .package-header {
            margin-left: 0;
        }
        
        .package-title,
        .package-subtitle {
            text-align: center;
        }
        
        .badges,
        .tags {
            justify-content: center;
        }
    }

    /* è¡Œå‹•ç‰ˆï¼ˆæ‰‹æ©Ÿï¼‰å„ªåŒ–ï¼šé…’åº—å¡ç‰‡æ›´ç·Šæ¹Šã€å–®æ¬„é¡¯ç¤ºã€è¼ƒå°åœ–ç‰‡é«˜åº¦ */
    @media (max-width: 640px) {
        .hotel-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .info-section {
            padding-left: 10px;
            padding-right: 10px;
        }
        .hotel-card {
            border-radius: 8px;
        }
        .hotel-image {
            height: 160px;
        }
        .hotel-body {
            padding: 12px;
        }
        .hotel-name {
            font-size: 1.05em;
            margin-bottom: 6px;
        }
        .period-section {
            padding: 14px !important;
            margin-left: -8px;
            margin-right: -8px;
        }
    }
    
    /* å¹³æ»‘æ»¾å‹• */
    html {
        scroll-behavior: smooth;
    }
    
    /* WhatsApp æŸ¥è©¢å€åŸŸ */
    .whatsapp-inquiry {
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        padding: 20px 25px;
        margin: 25px 0 25px 230px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        flex-wrap: wrap;
    }
    
    .whatsapp-inquiry-label {
        color: white;
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .whatsapp-inquiry select {
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        background: white;
        color: #128C7E;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        min-width: 150px;
        height: 48px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: all 0.3s;
    }
    
    .whatsapp-inquiry select:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .whatsapp-inquiry select:focus {
        outline: none;
        background: #FFD700;
        color: #128C7E;
    }
    
    .whatsapp-btn {
        background: white;
        color: #25D366;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        height: 48px;
        border: none;
    }
    
    .whatsapp-btn:hover {
        background: #FFD700;
        color: #128C7E;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .whatsapp-icon {
        font-size: 1.3em;
    }
    
    @media (max-width: 1024px) {
        .whatsapp-inquiry {
            margin-left: 0;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{% url 'main:package_list' %}">é¦–é </a> / 
    {% if continent %}
        <a href="{% url 'main:package_list_by_continent' continent.slug %}">{{ continent.name }}</a> / 
    {% endif %}
    {% if country %}
        <a href="{% url 'main:package_list_by_country' continent.slug country.slug %}">{{ country.name }}</a> / 
    {% endif %}
    {% if city %}
        <a href="{% url 'main:package_list_by_city' continent.slug country.slug city.slug %}">{{ city.name }}</a> / 
    {% endif %}
    <span>{{ package.name }}</span>
</div>

<div class="package-hero">
    {% if package.main_image %}
        <img src="{{ package.main_image.url }}" alt="{{ package.name }}" class="package-hero-image">
    {% endif %}
</div>

<div class="package-header">
    <h1 class="package-title">{{ package.name }}</h1>
    {% if package.subtitle %}
        <p class="package-subtitle">{{ package.subtitle }}</p>
    {% endif %}
    
    <div class="badges">
        <span class="badge badge-type">{{ package.package_type.name }}</span>
        {% if package.city %}
            <span class="badge badge-city">ğŸ“ {{ package.city.name }}</span>
            <span class="badge badge-country">ğŸŒ {{ package.city.country.name }}</span>
        {% endif %}
        {% if package.is_featured %}
            <span class="badge badge-featured">â­ ç²¾é¸å¥—ç¥¨</span>
        {% endif %}
    </div>
    
    {% if package.tags.all %}
        <div class="tags">
            {% for tag in package.tags.all %}
                <span class="tag" style="background-color: {{ tag.color }};">
                    {{ tag.name }}
                </span>
            {% endfor %}
        </div>
    {% endif %}
</div>

<!-- WhatsApp æŸ¥è©¢å€åŸŸ -->
<div class="whatsapp-inquiry">
    <span class="whatsapp-inquiry-label">ğŸ’¬ WhatsApp æŸ¥è©¢</span>
    <select id="person-count">
        <option value="1">ä¸€äºº</option>
        <option value="2">äºŒäºº</option>
        <option value="3">ä¸‰äºº</option>
        <option value="4">å››äºº</option>
        <option value="5">äº”äºº</option>
        <option value="6">å…­äºº</option>
        <option value="7">ä¸ƒäºº</option>
        <option value="8">å…«äºº</option>
        <option value="9">ä¹äºº</option>
        <option value="10">åäºº</option>
        <option value="more">åäººä»¥ä¸Š</option>
    </select>
    <a href="#" id="whatsapp-link" class="whatsapp-btn" target="_blank">
        <span class="whatsapp-icon">ğŸ“±</span>
        ç«‹å³æŸ¥è©¢
    </a>
</div>

<div class="content-wrapper">
    <!-- å·¦å´å°èˆªé¸å–® -->
    <nav class="side-nav">
        <a href="#introduction" class="side-nav-item">å¥—ç¥¨ç°¡ä»‹</a>
        <a href="#price-info" class="side-nav-item">åƒ¹éŒ¢åŠå…§å®¹</a>
        <a href="#itinerary" class="side-nav-item">è·¯ç·šè¡Œç¨‹</a>
        <a href="#notices" class="side-nav-item">è·¯ç·šé ˆçŸ¥</a>
        <a href="#print" class="side-nav-item">åˆ—å°</a>
        <a href="#share" class="side-nav-item">æˆ‘è¦åˆ†äº«</a>
        <a href="#other" class="side-nav-item">å…¶ä»–</a>
        <div class="side-nav-register">
            <a href="/admin/main/package/{{ package.id }}/change/" class="btn">ç«‹å³ç™»è¨˜/å ±è¨‚</a>
        </div>
    </nav>

    <div class="main-content">
{% if package.description %}
<div id="introduction" class="info-section">
    <h2>å¥—ç¥¨æè¿°</h2>
    <div class="info-content">
        {{ package.description|safe }}
    </div>
</div>
{% endif %}



{% if package.rich_text_table_one %}
<div class="info-section">
    <h2>é…’åº—è³‡è¨Š</h2>
    <div class="info-content" style="white-space: normal;">
        {{ package.rich_text_table_one|safe }}
    </div>
</div>
{% endif %}

{% if package.periods.all %}
<div id="print" class="hotel-section">
    <div class="info-section">
        <h2>åƒ¹æ ¼</h2>
        {% for period in package.periods.all %}
            {% if period.is_active %}
            <div class="period-section" style="margin-bottom: 30px; border: 2px solid #fbb700; border-radius: 10px; padding: 20px;">
                <h3 style="color: #fbb700; margin-bottom: 15px;">{{ period.period_text }}</h3>
                <div class="hotel-grid">
                    {% if period.hotel_name or period.room_type or period.price or period.image %}
                    <div class="hotel-card">
                        {% if period.image %}
                            <img src="{{ period.image.url }}" alt="{{ period.hotel_name }}" class="hotel-image">
                        {% else %}
                            <div class="hotel-image"></div>
                        {% endif %}
                        <div class="hotel-body">
                            <h4 class="hotel-name">{{ period.hotel_name }}</h4>
                            {% if period.room_type %}
                                <p><strong>æˆ¿å‹ï¼š</strong>{{ period.room_type }}</p>
                            {% endif %}
                            {% if period.price %}
                                <p><strong>åƒ¹æ ¼ï¼š</strong>${{ period.price|linebreaks }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% for info in period.hotel_infos.all %}
                    <div class="hotel-card">
                        {% if info.image %}
                            <img src="{{ info.image.url }}" alt="{{ info.hotel_name }}" class="hotel-image">
                        {% else %}
                            <div class="hotel-image"></div>
                        {% endif %}
                        <div class="hotel-body">
                            <h4 class="hotel-name">{{ info.hotel_name }}</h4>
                            {% if info.room_type %}
                                <p><strong>æˆ¿å‹ï¼š</strong>{{ info.room_type }}</p>
                            {% endif %}
                            {% if info.price %}
                                <p><strong>åƒ¹æ ¼ï¼š</strong>${{ info.price }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

{% if package.rich_text_table %}
<div class="info-section">
    <h2>åƒ¹æ ¼è¡¨äºŒ</h2>
    <div class="info-content" style="white-space: normal;">
        {{ package.rich_text_table|safe }}
    </div>
</div>
{% endif %}

{% if package.rich_text_table_three %}
<div id="itinerary" class="info-section">
    <h2>è¡Œç¨‹</h2>
    <div class="info-content" style="white-space: normal;">
        {{ package.rich_text_table_three|safe }}
    </div>
</div>
{% endif %}

{% if package.price_include_item %}
<div id="price-info" class="colored-section">
    <h2 class="colored-section-header yellow">å¥—é¤åƒ¹éŒ¢åŒ…æ‹¬</h2>
    <div class="colored-section-content">
        {{ package.price_include_item|safe }}
    </div>
</div>
{% endif %}

{% if package.price_exclude_item %}
<div class="colored-section">
    <h2 class="colored-section-header orange">å¥—é¤åƒ¹éŒ¢ä¸åŒ…æ‹¬</h2>
    <div class="colored-section-content">
        {{ package.price_exclude_item|safe }}
    </div>
</div>
{% endif %}

{% if package.flight_info %}
<div id="notices" class="colored-section">
    <h2 class="colored-section-header yellow">èˆªç­è³‡æ–™</h2>
    <div class="colored-section-content">
        {{ package.flight_info|safe }}
    </div>
</div>
{% endif %}

{% if package.tips %}
<div class="colored-section">
    <h2 class="colored-section-header yellow">é™„è¨»</h2>
    <div class="colored-section-content">
        {{ package.tips|safe }}
    </div>
</div>
{% endif %}



<div id="share" class="meta-info">
    <h3 style="margin-bottom: 15px; color: #1976d2;">ğŸ“‹ å¥—ç¥¨è³‡è¨Š</h3>
    <p><strong>å¥—ç¥¨ IDï¼š</strong>{{ package.id }}</p>
    <p><strong>å¥—ç¥¨ç¨®é¡ï¼š</strong>{{ package.package_type.name }}</p>
    {% if package.city %}
        <p><strong>åŸå¸‚ï¼š</strong>{{ package.city.name }} ({{ package.city.country.name }})</p>
    {% endif %}
    <p><strong>å•Ÿç”¨ç‹€æ…‹ï¼š</strong>{% if package.is_active %}âœ… å·²å•Ÿç”¨{% else %}âŒ æœªå•Ÿç”¨{% endif %}</p>
    <p><strong>ç²¾é¸ç‹€æ…‹ï¼š</strong>{% if package.is_featured %}â­ æ˜¯{% else %}å¦{% endif %}</p>
    <p><strong>å»ºç«‹æ™‚é–“ï¼š</strong>{{ package.created_at|date:"Yå¹´mæœˆdæ—¥ H:i:s" }}</p>
    <p><strong>æ›´æ–°æ™‚é–“ï¼š</strong>{{ package.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i:s" }}</p>
</div>

<div id="other" class="action-buttons">
    {% if city and country and continent %}
        <a href="{% url 'main:package_list_by_city' continent.slug country.slug city.slug %}" class="btn btn-secondary">â† è¿”å› {{ city.name }} åˆ—è¡¨</a>
    {% elif country and continent %}
        <a href="{% url 'main:package_list_by_country' continent.slug country.slug %}" class="btn btn-secondary">â† è¿”å› {{ country.name }} åˆ—è¡¨</a>
    {% elif continent %}
        <a href="{% url 'main:package_list_by_continent' continent.slug %}" class="btn btn-secondary">â† è¿”å› {{ continent.name }} åˆ—è¡¨</a>
    {% else %}
        <a href="{% url 'main:package_list' %}" class="btn btn-secondary">â† è¿”å›åˆ—è¡¨</a>
    {% endif %}
    <a href="/admin/main/package/{{ package.id }}/change/" class="btn">ç·¨è¼¯å¥—ç¥¨</a>
</div>
    </div><!-- .main-content -->
</div><!-- .content-wrapper -->

<script>
// æ»¾å‹•ç›£è½ï¼Œè‡ªå‹•é«˜äº®ç•¶å‰å€å¡Šå°æ‡‰çš„é¸å–®é …
document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.side-nav-item');
    const sections = document.querySelectorAll('[id]');
    
    function highlightNav() {
        let current = '';
        let currentPosition = window.pageYOffset + 200;
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (currentPosition >= sectionTop && currentPosition < sectionTop + sectionHeight) {
                current = section.getAttribute('id');
            }
        });
        
        navItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('href') === '#' + current) {
                item.classList.add('active');
            }
        });
    }
    
    window.addEventListener('scroll', highlightNav);
    highlightNav();
    
    // WhatsApp æŸ¥è©¢åŠŸèƒ½
    const personCountSelect = document.getElementById('person-count');
    const whatsappLink = document.getElementById('whatsapp-link');
    const packageName = "{{ package.name|escapejs }}";
    
    // æ•¸å­—è½‰ä¸­æ–‡
    const numberToChinese = {
        '1': 'ä¸€',
        '2': 'äºŒ',
        '3': 'ä¸‰',
        '4': 'å››',
        '5': 'äº”',
        '6': 'å…­',
        '7': 'ä¸ƒ',
        '8': 'å…«',
        '9': 'ä¹',
        '10': 'å',
        'more': 'åäººä»¥ä¸Š'
    };
    
    function updateWhatsAppLink() {
        const personCount = personCountSelect.value;
        const personText = numberToChinese[personCount] || personCount;
        let message = `æˆ‘æƒ³æŸ¥è©¢ ${packageName} å‡ºç™¼äººæ•¸ç‚º`;
        
        if (personCount === 'more') {
            message += personText;
        } else {
            message += personText + 'äºº';
        }
        
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://api.whatsapp.com/send?phone=85297986315&text=${encodedMessage}`;
        whatsappLink.href = whatsappUrl;
    }
    
    // åˆå§‹åŒ–é€£çµ
    updateWhatsAppLink();
    
    // ç›£è½ä¸‹æ‹‰é¸å–®è®ŠåŒ–
    personCountSelect.addEventListener('change', updateWhatsAppLink);
});
</script>
{% endblock %}

