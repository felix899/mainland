{% extends "admin/change_form.html" %}
{% load static %}

{# åƒè€ƒèˆŠå°ˆæ¡ˆ sns çš„è‡ªè¨‚ change_formï¼Œé€™è£¡åªåœ¨é é¢åº•éƒ¨åŠ ä¸Šä¸€å€‹ AI å¹«æ‰‹å€å¡Š #}

{% block after_related_objects %}
    {{ block.super }}

    {% if original %}
    <div class="module aligned" id="ai-description-helper" style="margin-top: 20px;">
        <h2>ğŸ¤– AI å…§å®¹ç”ŸæˆåŠ©æ‰‹</h2>
        <p>
            åœ¨ä¸Šæ–¹çš„ã€Œ<strong>AI æç¤ºè©ï¼ˆæè¿°ï¼‰</strong>ã€æ¬„ä½ä¸­è¼¸å…¥æç¤ºè©ï¼Œç„¶å¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œ<br>
            ç³»çµ±æœƒé€é Perplexity AI è‡ªå‹•ç‚ºæ­¤å¥—ç¥¨ç”¢ç”Ÿã€Œå¥—ç¥¨æè¿°ã€å…§å®¹ã€‚
        </p>
        <div style="margin: 10px 0;">
            <button type="button" class="button default" id="generate-ai-description-btn">
                ç”Ÿæˆ AI å…§å®¹
            </button>
            <span id="generate-ai-description-status" style="margin-left: 10px; font-weight: bold;"></span>
        </div>
        <p style="color: #666; font-size: 12px;">
            æé†’ï¼šAI ç”Ÿæˆçš„å…§å®¹æœƒç›´æ¥è¦†è“‹ã€Œå¥—ç¥¨æè¿°ã€æ¬„ä½ï¼Œè«‹åœ¨å„²å­˜å‰å…ˆç¢ºèªå…§å®¹æ˜¯å¦éœ€è¦æ‰‹å‹•èª¿æ•´ã€‚
        </p>
    </div>

    <script>
        (function() {
            const btn = document.getElementById('generate-ai-description-btn');
            const statusEl = document.getElementById('generate-ai-description-status');

            if (!btn) {
                return;
            }

            btn.addEventListener('click', function() {
                statusEl.style.color = '#333';
                statusEl.textContent = 'æ­£åœ¨å‘ AI å–å¾—å…§å®¹ï¼Œè«‹ç¨å€™...';

                // å–å¾— AI æç¤ºè©æ¬„ä½ï¼ˆid ä¾ç…§ Django admin çš„å‘½åè¦å‰‡ï¼‰
                const promptField = document.getElementById('id_ai_prompt_description');
                if (!promptField || !promptField.value.trim()) {
                    statusEl.style.color = 'red';
                    statusEl.textContent = 'è«‹å…ˆåœ¨ã€ŒAI æç¤ºè©ï¼ˆæè¿°ï¼‰ã€æ¬„ä½è¼¸å…¥å…§å®¹ã€‚';
                    return;
                }

                const prompt = promptField.value.trim();

                // å–å¾—ç•¶å‰é é¢çš„ URLï¼Œçµ„å‡º generate-ai-description API ä½å€
                // ç›®å‰ change é é¢è·¯å¾‘é¡ä¼¼ï¼š/admin/main/package/<id>/change/
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                const pkIndex = pathParts.indexOf('package') + 1;
                const packageId = pathParts[pkIndex];

                const url = `/admin/main/package/${packageId}/generate-ai-description/`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': (function() {
                            const name = 'csrftoken';
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    return decodeURIComponent(cookie.substring(name.length + 1));
                                }
                            }
                            return '';
                        })()
                    },
                    body: JSON.stringify({ai_prompt: prompt})
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    if (data.success) {
                        // å°‹æ‰¾ description å°æ‡‰çš„ CKEditor æˆ– textarea
                        const descTextarea = document.getElementById('id_description');
                        if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances['id_description']) {
                            CKEDITOR.instances['id_description'].setData(data.content || '');
                        } else if (descTextarea) {
                            descTextarea.value = data.content || '';
                        }
                        statusEl.style.color = 'green';
                        statusEl.textContent = 'AI å…§å®¹ç”ŸæˆæˆåŠŸï¼Œå·²å¡«å…¥ã€Œå¥—ç¥¨æè¿°ã€æ¬„ä½ï¼Œè«‹ç¢ºèªå¾Œå†å„²å­˜ã€‚';
                    } else {
                        statusEl.style.color = 'red';
                        statusEl.textContent = data.error || 'AI ç”Ÿæˆå…§å®¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    }
                }).catch(function(error) {
                    console.error('AI å…§å®¹ç”ŸæˆéŒ¯èª¤:', error);
                    statusEl.style.color = 'red';
                    statusEl.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•å–å¾— AI å…§å®¹ã€‚';
                });
            });
        })();
    </script>
    {% endif %}
{% endblock %}


